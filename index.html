<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planning tot en met 30 april 2026</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planning tot en met 30 april 2026</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--p:#3498db;--s:#27ae60;--w:#f39c12;--d:#e74c3c;--u:#9b59b6;--k:#2c3e50;--g:#95a5a6}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f4f6f9;color:#2c3e50;padding:16px;line-height:1.5}
  h1{text-align:center;margin:8px 0 4px;font-size:1.7em}
  .subtitle{text-align:center;color:#7f8c8d;font-size:0.95em;margin-bottom:16px}
  .user-input,.controls,.search-filter{text-align:center;margin-bottom:18px}
  input,select,button{font:inherit;padding:11px 15px;border-radius:8px;border:1px solid #ddd;margin:0 6px}
  button{background:var(--p);color:white;border:none;cursor:pointer;transition:.2s}
  button:hover{filter:brightness(0.92);transform:translateY(-1px)}
  .btn.sort{background:var(--u)}.btn.reset{background:var(--d)}.export-btn{background:var(--s)}
  .current-user{text-align:center;font-weight:bold;margin:14px 0;font-size:1.05em}
  .current-user .limit{color:#e67e22;font-weight:normal;font-size:0.9em}
  .kanban{display:flex;gap:22px;overflow-x:auto;padding:20px 0;scroll-snap-type:x mandatory;justify-content:center}
  .kanban::-webkit-scrollbar{height:9px}.kanban::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:4px}
  .column{background:#e2e8f0;border-radius:14px;width:480px;min-width:480px;padding:18px;box-shadow:0 6px 16px rgba(0,0,0,.08);scroll-snap-align:center}
  .column h2{margin-bottom:14px;padding-bottom:8px;border-bottom:3px solid;font-size:1.25em;text-transform:uppercase;letter-spacing:0.6px;display:flex;justify-content:space-between;align-items:center}
  .scoping h2{border-color:var(--p);color:#2980b9}
  .refinement h2{border-color:var(--w);color:#e67e22}
  .delivery h2{border-color:var(--s);color:#229954}
  .column h2 span{font-size:0.82em;background:rgba(255,255,255,.9);padding:5px 10px;border-radius:6px}

  /* ==== VASTGEZETTE OPLOSSING VOOR ID-LABEL ==== */
  .card{
    background:white;padding:16px;margin-bottom:11px;border-radius:12px;
    box-shadow:0 3px 8px rgba(0,0,0,.1);cursor:grab;transition:all .25s;
    position:relative;display:flex;flex-direction:column;min-height:68px;
  }
  .card:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
  .card.dragging{opacity:0.7;transform:rotate(6deg) scale(1.04);box-shadow:0 20px 40px rgba(0,0,0,.3);z-index:1000}

.card-content {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  margin-bottom: 20px;          /* ruimte onder de tekst voor het ID-label */
  position: relative;
}
.card-text {
  flex: 1;
  font-size: 0.96em;
  word-break: break-word;
  padding-right: 55px;          /* ruimte voor de stem-badge rechts */
  padding-bottom: 10px;         /* voorkomt dat lange tekst over ID heen loopt */
  min-height: 44px;             /* zorgt dat korte taken ook ruimte hebben */
}
  .vote-badge{
    background:var(--g);color:white;width:44px;height:44px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:0.98em;
    transition:all .25s;flex-shrink:0;
  }
  .vote-badge:hover{transform:scale(1.18)}
  .vote-badge.voted{background:var(--s)}
  .vote-badge.my-vote{background:var(--p);box-shadow:0 0 0 3px white,0 0 0 6px var(--p)}

  /* ID-label nu netjes onderaan, altijd zichtbaar en nooit overlappend */
  .task-id{
    position:absolute;bottom:8px;left:12px;background:rgba(0,0,0,0.07);color:#444;
    font-size:0.70em;font-weight:bold;padding:3px 8px;border-radius:5px;
    pointer-events:none;z-index:10;
  }

  .vote-details{
    position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:14px;
    background:var(--k);color:white;padding:12px 16px;border-radius:10px;font-size:0.86em;
    max-width:280px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:9999;display:none;pointer-events:none;
  }
  .vote-details.show{display:block}
  .vote-details::before{content:'';position:absolute;top:50%;left:-8px;transform:translateY(-50%);
    border:8px solid transparent;border-right-color:var(--k)}

  #loading{text-align:center;padding:60px 20px;font-size:1.2em;color:#7f8c8d}
  #sync-status{height:24px;font-size:0.9em}
  @media(max-width:1100px){.column{min-width:400px;width:400px}}
  @media(max-width:800px){.column{min-width:340px;width:340px}
    input,button,select{width:100%;margin:8px 0;display:block}.kanban{gap:16px;padding:16px 0}
  }
</style>
</head>
<body>
<h1>Planning tot en met 30 april 2026</h1>
<p class="subtitle">Stem • Sleep • Zoek • Exporteer • v1.12 – Taak-ID zichtbaar</p>

<div class="user-input">
  <input type="text" id="user-name" placeholder="Jouw naam (bijv. Bas)">
  <button class="btn" onclick="setUser()">Starten met stemmen</button>
  <button class="btn sort" onclick="sortByVotes()">Sorteren op stemmen</button>
  <button class="btn" onclick="loadVotesFromSheets()" style="background:var(--u)">Stemmen laden</button>
  <div id="sync-status"></div>
</div>

<div class="current-user" id="current-user-display" style="display:none">
  Je stemt als: <strong id="user-name-display"></strong> 
  <span class="limit" id="vote-limit"></span>
</div>

<div class="search-filter">
  <input type="text" id="search-input" placeholder="Zoeken in taken..." onkeyup="filterCards()">
  <select id="filter-my-votes" onchange="filterCards()">
    <option value="">Alle taken</option>
    <option value="my">Alleen mijn stemmen</option>
  </select>
</div>

<div class="controls">
  <button class="export-btn" onclick="exportToCSV()">CSV</button>
  <button class="export-btn" onclick="exportToPNG()">PNG</button>
  <button class="export-btn" onclick="exportToPDF()">PDF</button>
  <button class="btn reset" onclick="resetBoard()">Reset alles</button>
</div>

<div id="loading">Laden van taken uit Google Sheet...</div>

<div class="kanban" id="kanban" style="display:none">
  <div class="column scoping" data-column="scoping">
    <h2>1. Scoping (To Do) <span id="scoping-count">0</span></h2>
    <div id="scoping-cards"></div>
  </div>
  <div class="column refinement" data-column="refinement">
    <h2>2. Refinement (In Progress) <span id="refinement-count">0</span></h2>
    <div id="refinement-cards"></div>
  </div>
  <div class="column delivery" data-column="delivery">
    <h2>3. Delivery (Done) <span id="delivery-count">0</span></h2>
    <div id="delivery-cards"></div>
  </div>
</div>

<script>
// =============== CONFIG ===============
const SHEET_ID = '18IFms6irl9dz_wPku-LdAgsrm681mttYSBuhWmCHLfI';
const STEMMEN_GID = '141552524';
const MAX_VOTES = 5;

const TASKS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
const VOTES_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${STEMMEN_GID}`;
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxp96H0zhBvBLG0GuIDt1ThXrBGoFTyIQFJbZw3Q3JbKVjUQ08CddNxyeQSV_izTcgz/exec';

const data = { tasks: {scoping:[], refinement:[], delivery:[]}, votes: {}, taskMap: {} };
let currentUser = null;

// =============== LADEN TAKEN ===============
async function fetchTasks() {
  try {
    const r = await fetch(TASKS_URL + '&headers=1');
    const text = await r.text();
    const rows = text.split('\n').map(l => l.slice(1,-1).split('","'));
    const scoping = [], refinement = [], delivery = [];
    rows.slice(1).forEach(row => {
      if (row[0]) scoping.push(row[0].trim());
      if (row[1]) refinement.push(row[1].trim());
      if (row[2]) delivery.push(row[2].trim());
    });
    let id = 1;
    [...scoping, ...refinement, ...delivery].forEach(t => { if(t) data.taskMap['t'+id++] = t; });
    data.tasks.scoping = scoping.map((_,i)=>`t${i+1}`);
    data.tasks.refinement = refinement.map((_,i)=>`t${scoping.length+i+1}`);
    data.tasks.delivery = delivery.map((_,i)=>`t${scoping.length+refinement.length+i+1}`);
  } catch(e) {
    console.warn('Fallback data', e);
    const fb = ["Koppeling datawarehouse","Verwijderen indicatief rentetarief","CAMT aanpassingen","DBU pipeline","Archivering database"];
    fb.forEach((t,i)=>data.taskMap['t'+(i+1)]=t);
    data.tasks = {scoping:['t1','t2'], refinement:['t3','t4'], delivery:['t5']};
  }
}

// =============== SYNC MET GOOGLE SHEETS ===============
async function syncVotesFromSheets() {
  const status = document.getElementById('sync-status');
  status.textContent = 'Sync met Google Sheets...'; status.style.color = '#f39c12';
  try {
    const r = await fetch(VOTES_URL);
    const text = await r.text();
    const rows = text.split('\n').slice(1);
    const newVotes = {};
    rows.forEach(row => {
      const c = row.slice(1,-1).split('","');
      if (c.length >= 5) {
        const taskId = c[2]; const user = c[1]; const cnt = parseInt(c[4]);
        if (taskId && cnt > 0) {
          if (!newVotes[taskId]) newVotes[taskId] = {};
          newVotes[taskId][user.trim()] = cnt;
        }
      }
    });
    if (Object.keys(newVotes).length) data.votes = newVotes;
    localStorage.setItem('kanban-votes', JSON.stringify(data.votes));
    status.textContent = 'Sync gelukt!'; status.style.color = 'green';
  } catch(e) {
    status.textContent = 'Sync mislukt (offline?)'; status.style.color = 'orange';
  }
  setTimeout(()=>status.textContent='',4000);
}

async function saveToSheets() {
  if (!currentUser) return;
  const payload = { action:"save", user:currentUser, votes:data.votes, tasks:data.tasks, taskMap:data.taskMap };
  try {
    await fetch(WEB_APP_URL, {method:"POST",mode:"no-cors",body:JSON.stringify(payload)});
  } catch(e) { console.warn('Sync mislukt',e); }
}

// =============== RENDEREN (MET ZICHTBARE ID) ===============
function renderAll() {
  ['scoping','refinement','delivery'].forEach(col => {
    const cont = document.getElementById(col+'-cards'); cont.innerHTML = '';
    getVisible(col).forEach(id => cont.appendChild(createCard(id)));
  });
  updateCounts(); updateLimit();
}

function getVisible(col) {
  const search = document.getElementById('search-input').value.toLowerCase();
  const onlyMy = document.getElementById('filter-my-votes').value==='my';
  return data.tasks[col].filter(id => {
    const text = data.taskMap[id] || '';
    if (search && !text.toLowerCase().includes(search)) return false;
    if (onlyMy && currentUser && !(data.votes[id]?.[currentUser])) return false;
    return true;
  });
}

function createCard(id) {
  const text = data.taskMap[id];
  const votes = data.votes[id] || {};
  const total = Object.values(votes).reduce((a,b)=>a+b,0);
  const mine = currentUser ? (votes[currentUser]||0) : 0;

  const card = document.createElement('div');
  card.className = 'card'; card.draggable = true; card.dataset.taskId = id;
  card.ondragstart = e => { e.dataTransfer.setData('id',id); card.classList.add('dragging'); };

card.innerHTML = `
  <div class="card-content">
    <div class="card-text">${text}</div>
    <div class="vote-badge">${total||0}</div>
  </div>
  <div class="task-id">ID: ${id.toUpperCase()}</div>
`;

  const badge = card.querySelector('.vote-badge');
  if(total>0) badge.classList.add('voted');
  if(mine>0) badge.classList.add('my-vote');

  const details = document.createElement('div');
  details.className = 'vote-details';
  let html = Object.entries(votes).map(([u,c])=>`<div><strong>${u}</strong>: ${c}</div>`).join('');
  details.innerHTML = html||'<div>Nog geen stemmen</div>';
  badge.appendChild(details);

  badge.onmouseenter = () => details.classList.add('show');
  badge.onmouseleave = () => details.classList.remove('show');

  badge.onclick = e => {
    e.stopPropagation();
    if (!currentUser) return alert('Voer eerst je naam in!');
    if (mine > 0) {
      data.votes[id][currentUser]--;
      if (data.votes[id][currentUser] <= 0) delete data.votes[id][currentUser];
      if (!Object.keys(data.votes[id]).length) delete data.votes[id];
    } else {
      if (getMyVotes() >= MAX_VOTES) return alert(`Je hebt al ${MAX_VOTES} stemmen gebruikt!`);
      if (!data.votes[id]) data.votes[id] = {};
      data.votes[id][currentUser] = 1;
    }
    localStorage.setItem('kanban-votes', JSON.stringify(data.votes));
    saveToSheets();
    renderAll();
  };

  return card;
}

// De rest van de functies (updateCounts, getMyVotes, setUser, sortByVotes, drag&drop, export, etc.) blijven 100% hetzelfde als v1.0
function updateCounts() {
  ['scoping','refinement','delivery'].forEach(col => {
    const visible = getVisible(col).length;
    const votes = data.tasks[col].reduce((s,id)=> s + Object.values(data.votes[id]||{}).reduce((a,b)=>a+b,0),0);
    document.getElementById(col+'-count').textContent = `${visible} taken • ${votes} stemmen`;
  });
}
function getMyVotes() { return Object.values(data.votes).reduce((s,obj)=> s + (obj[currentUser]||0),0); }
function updateLimit() {
  if (!currentUser) return;
  const used = getMyVotes();
  document.getElementById('vote-limit').textContent = ` (${used}/${MAX_VOTES} gebruikt)`;
  document.getElementById('vote-limit').style.color = used>=MAX_VOTES ? 'red' : '#e67e22';
}
function setUser() {
  const name = document.getElementById('user-name').value.trim();
  if (!name) return alert('Voer je naam in!');
  currentUser = name;
  localStorage.setItem('kanban-user', name);
  document.getElementById('current-user-display').style.display = 'block';
  document.getElementById('user-name-display').textContent = name;
  updateLimit(); renderAll();
}
function sortByVotes() {
  Object.keys(data.tasks).forEach(col => {
    data.tasks[col].sort((a,b) => Object.values(data.votes[b]||{}).reduce((x,y)=>x+y,0) - Object.values(data.votes[a]||{}).reduce((x,y)=>x+y,0));
  });
  renderAll();
}
function filterCards() { renderAll(); }

// Drag & drop
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  const id = e.dataTransfer.getData('id');
  const card = document.querySelector(`[data-task-id="${id}"]`);
  if (!card) return;
  const column = e.target.closest('.column');
  if (!column) return;
  column.querySelector('[id$="-cards"]').appendChild(card);
  const key = column.dataset.column;
  data.tasks[key] = Array.from(column.querySelectorAll('.card')).map(c=>c.dataset.taskId);
  saveToSheets();
  renderAll();
});

// Export functies (ongewijzigd)
function exportToCSV() { /* zelfde als v1.0 */ let csv = "Kolom,Taak,ID,Totaal stemmen,Stemmers\n"; const names = {scoping:"Scoping",refinement:"Refinement",delivery:"Delivery"}; Object.keys(data.tasks).forEach(col=>{data.tasks[col].forEach(id=>{const v=data.votes[id]||{};const tot=Object.values(v).reduce((a,b)=>a+b,0);const det=Object.entries(v).map(([n,c])=>`${n}:${c}`).join(' | ');csv += `${names[col]},"${data.taskMap[id]}",${id.toUpperCase()},${tot},"${det}"\n`;})}); const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));a.download=`planning-${new Date().toISOString().slice(0,10)}.csv`;a.click(); }
function exportToPNG() { document.querySelectorAll('.user-input,.controls,.search-filter,.current-user').forEach(el=>el.style.display='none'); html2canvas(document.body,{scale:2,backgroundColor:'#f4f6f9'}).then(c=>{const a=document.createElement('a');a.href=c.toDataURL();a.download=`planning-${new Date().toISOString().slice(0,10)}.png`;a.click();document.querySelectorAll('.user-input,.controls,.search-filter,.current-user').forEach(el=>el.style.display='');}); }
function exportToPDF() { const {jsPDF}=window.jspdf; document.querySelectorAll('.user-input,.controls,.search-filter,.current-user').forEach(el=>el.style.display='none'); html2canvas(document.querySelector('.kanban'),{scale:2}).then(c=>{const doc=new jsPDF('l','mm','a4');const w=doc.internal.pageSize.getWidth()-40;doc.setFontSize(18);doc.text("Planning tot 30 april 2026",w/2+20,20,{align:'center'});doc.addImage(c.toDataURL(),'PNG',20,30,w,c.height*w/c.width);doc.save(`planning-${new Date().toISOString().slice(0,10)}.pdf`);document.querySelectorAll('.user-input,.controls,.search-filter,.current-user').forEach(el=>el.style.display='');}); }
function resetBoard() { if(confirm('Weet je zeker dat je ALLES wilt resetten?')){localStorage.clear();location.reload();} }

// Start
(async () => {
  await fetchTasks();
  await syncVotesFromSheets();
  if (localStorage.getItem('kanban-user')) {
    currentUser = localStorage.getItem('kanban-user');
    document.getElementById('current-user-display').style.display = 'block';
    document.getElementById('user-name-display').textContent = currentUser;
  }
  renderAll();
  document.getElementById('loading').remove();
  document.getElementById('kanban').style.display = 'flex';
})();
</script>
</body>
</html>



